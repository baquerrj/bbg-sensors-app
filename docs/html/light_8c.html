<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ECEN5013 Project1 - Roberto Baquerizo: /home/baquerrj/boulder/ecen5013/project_1/src/light.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ECEN5013 Project1 - Roberto Baquerizo
   </div>
   <div id="projectbrief">Environment Monitoring Application for BeagleBone Green</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">light.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Interface to APDS9301 Light Sensor.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="watchdog_8h_source.html">watchdog.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="light_8h_source.html">light.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="led_8h_source.html">led.h</a>&quot;</code><br />
<code>#include &lt;errno.h&gt;</code><br />
<code>#include &lt;time.h&gt;</code><br />
<code>#include &lt;string.h&gt;</code><br />
<code>#include &lt;math.h&gt;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for light.c:</div>
<div class="dyncontent">
<div class="center"><img src="light_8c__incl.png" border="0" usemap="#_2home_2baquerrj_2boulder_2ecen5013_2project__1_2src_2light_8c" alt=""/></div>
<!-- MAP 0 -->
</div>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a366471b5822de7615f33cbe5eab9726a"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a366471b5822de7615f33cbe5eab9726a">sig_handler</a> (int signo)</td></tr>
<tr class="memdesc:a366471b5822de7615f33cbe5eab9726a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Signal handler for light sensor thread. On normal operation, we should be receving SIGUSR1/2 signals from watchdog when prompted to exit. So, we close the message queue and timer this thread owns.  <a href="#a366471b5822de7615f33cbe5eab9726a">More...</a><br /></td></tr>
<tr class="separator:a366471b5822de7615f33cbe5eab9726a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4f3aa3fb3750262d938e191252db81fb"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a4f3aa3fb3750262d938e191252db81fb">timer_handler</a> (union sigval sig)</td></tr>
<tr class="memdesc:a4f3aa3fb3750262d938e191252db81fb"><td class="mdescLeft">&#160;</td><td class="mdescRight">Timer handler function for light sensor thread When woken up by the timer, get lux reading and write state to shared memory.  <a href="#a4f3aa3fb3750262d938e191252db81fb">More...</a><br /></td></tr>
<tr class="separator:a4f3aa3fb3750262d938e191252db81fb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7f1c59e171c9db2a7609a4cd8b61fa2c"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a7f1c59e171c9db2a7609a4cd8b61fa2c">get_lux</a> (void)</td></tr>
<tr class="memdesc:a7f1c59e171c9db2a7609a4cd8b61fa2c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Returns last lux reading.  <a href="#a7f1c59e171c9db2a7609a4cd8b61fa2c">More...</a><br /></td></tr>
<tr class="separator:a7f1c59e171c9db2a7609a4cd8b61fa2c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5ba3d2c92432bf82f3f3cc4e809b1dba"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a5ba3d2c92432bf82f3f3cc4e809b1dba">is_dark</a> (void)</td></tr>
<tr class="memdesc:a5ba3d2c92432bf82f3f3cc4e809b1dba"><td class="mdescLeft">&#160;</td><td class="mdescRight">Returns int speciyfing if it is night or day.  <a href="#a5ba3d2c92432bf82f3f3cc4e809b1dba">More...</a><br /></td></tr>
<tr class="separator:a5ba3d2c92432bf82f3f3cc4e809b1dba"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac3c04aef00858dc27815e190f8186cfd"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#ac3c04aef00858dc27815e190f8186cfd">apds9301_set_config</a> (void)</td></tr>
<tr class="memdesc:ac3c04aef00858dc27815e190f8186cfd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set configuration of light sensor. For the APDS9301, the configuration is spread out across the: Timing Register, Interrupt Control Register, and Control Register. So, I have to write to all of these to set the config.  <a href="#ac3c04aef00858dc27815e190f8186cfd">More...</a><br /></td></tr>
<tr class="separator:ac3c04aef00858dc27815e190f8186cfd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a99e9814d23261d099bf5d381d84d6642"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a99e9814d23261d099bf5d381d84d6642">apds9301_set_integration</a> (uint8_t val)</td></tr>
<tr class="memdesc:a99e9814d23261d099bf5d381d84d6642"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sets the integration time for APDS9301 by writing a value to bits INTEG of the Timing Register.  <a href="#a99e9814d23261d099bf5d381d84d6642">More...</a><br /></td></tr>
<tr class="separator:a99e9814d23261d099bf5d381d84d6642"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a145d5bf45a3d1527eaa860a2a4ce545b"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a145d5bf45a3d1527eaa860a2a4ce545b">apds9301_clear_interrupt</a> (void)</td></tr>
<tr class="memdesc:a145d5bf45a3d1527eaa860a2a4ce545b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Clears any pending interrupt for APDS9301 by writing a 1 to the CLEAR bit of the Command Register.  <a href="#a145d5bf45a3d1527eaa860a2a4ce545b">More...</a><br /></td></tr>
<tr class="separator:a145d5bf45a3d1527eaa860a2a4ce545b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3b06e19e8c55d93415a41352cf11de16"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a3b06e19e8c55d93415a41352cf11de16">apds9301_set_interrupt</a> (uint8_t enable)</td></tr>
<tr class="memdesc:a3b06e19e8c55d93415a41352cf11de16"><td class="mdescLeft">&#160;</td><td class="mdescRight">Enables or disables interrupts for APDS9301 by setting or clearing the INTR bits of the Interrupt Control Register.  <a href="#a3b06e19e8c55d93415a41352cf11de16">More...</a><br /></td></tr>
<tr class="separator:a3b06e19e8c55d93415a41352cf11de16"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3063fd5cfc043ce2ac7c67f8af9b4b2e"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a3063fd5cfc043ce2ac7c67f8af9b4b2e">apds9301_set_gain</a> (uint8_t gain)</td></tr>
<tr class="memdesc:a3063fd5cfc043ce2ac7c67f8af9b4b2e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sets gain for APDS9301 by setting or clearing the GAIN bit of the Timing Register.  <a href="#a3063fd5cfc043ce2ac7c67f8af9b4b2e">More...</a><br /></td></tr>
<tr class="separator:a3063fd5cfc043ce2ac7c67f8af9b4b2e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8e844b99f75ecdf6712faaaddc0eb396"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a8e844b99f75ecdf6712faaaddc0eb396">apds9301_read_control</a> (uint8_t *data)</td></tr>
<tr class="memdesc:a8e844b99f75ecdf6712faaaddc0eb396"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read contents of Control Register.  <a href="#a8e844b99f75ecdf6712faaaddc0eb396">More...</a><br /></td></tr>
<tr class="separator:a8e844b99f75ecdf6712faaaddc0eb396"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae2c85da2e138447c5881122669c36a38"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#ae2c85da2e138447c5881122669c36a38">apds9301_write_threshold_low</a> (uint16_t threshold)</td></tr>
<tr class="memdesc:ae2c85da2e138447c5881122669c36a38"><td class="mdescLeft">&#160;</td><td class="mdescRight">Write value to low threshold register.  <a href="#ae2c85da2e138447c5881122669c36a38">More...</a><br /></td></tr>
<tr class="separator:ae2c85da2e138447c5881122669c36a38"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a67500fb59f0ab2f2e46c3b6f945985b5"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a67500fb59f0ab2f2e46c3b6f945985b5">apds9301_read_threshold_low</a> (uint16_t *threshold)</td></tr>
<tr class="memdesc:a67500fb59f0ab2f2e46c3b6f945985b5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read value from low threshold register.  <a href="#a67500fb59f0ab2f2e46c3b6f945985b5">More...</a><br /></td></tr>
<tr class="separator:a67500fb59f0ab2f2e46c3b6f945985b5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adb39e9954b4d948edea845453df2abf6"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#adb39e9954b4d948edea845453df2abf6">apds9301_write_threshold_high</a> (uint16_t threshold)</td></tr>
<tr class="memdesc:adb39e9954b4d948edea845453df2abf6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Write value to high threshold register.  <a href="#adb39e9954b4d948edea845453df2abf6">More...</a><br /></td></tr>
<tr class="separator:adb39e9954b4d948edea845453df2abf6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0005300d36508d20c372b5355d6546d9"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a0005300d36508d20c372b5355d6546d9">apds9301_read_threshold_high</a> (uint16_t *threshold)</td></tr>
<tr class="memdesc:a0005300d36508d20c372b5355d6546d9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read value from high threshold register.  <a href="#a0005300d36508d20c372b5355d6546d9">More...</a><br /></td></tr>
<tr class="separator:a0005300d36508d20c372b5355d6546d9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6dbf3801330c345b999db86f018c94cf"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a6dbf3801330c345b999db86f018c94cf">apds9301_read_id</a> (uint8_t *id)</td></tr>
<tr class="memdesc:a6dbf3801330c345b999db86f018c94cf"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read APDS9301 Identification Register.  <a href="#a6dbf3801330c345b999db86f018c94cf">More...</a><br /></td></tr>
<tr class="separator:a6dbf3801330c345b999db86f018c94cf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a14680b863ba54159dba03357d4745a16"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a14680b863ba54159dba03357d4745a16">apds9301_get_lux</a> (float *lux)</td></tr>
<tr class="memdesc:a14680b863ba54159dba03357d4745a16"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read ADC Registers and calculate lux in lumen using equations from APDS9301 datasheet.  <a href="#a14680b863ba54159dba03357d4745a16">More...</a><br /></td></tr>
<tr class="separator:a14680b863ba54159dba03357d4745a16"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a96f9f9c1e4e86cc148aa0a334a399d8d"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a96f9f9c1e4e86cc148aa0a334a399d8d">apds9301_read_data0</a> (uint16_t *data)</td></tr>
<tr class="memdesc:a96f9f9c1e4e86cc148aa0a334a399d8d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read ADC register for channel 0.  <a href="#a96f9f9c1e4e86cc148aa0a334a399d8d">More...</a><br /></td></tr>
<tr class="separator:a96f9f9c1e4e86cc148aa0a334a399d8d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a342a83b7263a75c5b12bffc638b2797e"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a342a83b7263a75c5b12bffc638b2797e">apds9301_read_data1</a> (uint16_t *data)</td></tr>
<tr class="memdesc:a342a83b7263a75c5b12bffc638b2797e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read ADC register for channel 1.  <a href="#a342a83b7263a75c5b12bffc638b2797e">More...</a><br /></td></tr>
<tr class="separator:a342a83b7263a75c5b12bffc638b2797e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a163ea457431a4845d5ff5fa205f670b7"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a163ea457431a4845d5ff5fa205f670b7">apds9301_power</a> (uint16_t on)</td></tr>
<tr class="memdesc:a163ea457431a4845d5ff5fa205f670b7"><td class="mdescLeft">&#160;</td><td class="mdescRight">power on (or off) APDS9301 as set by paramater  <a href="#a163ea457431a4845d5ff5fa205f670b7">More...</a><br /></td></tr>
<tr class="separator:a163ea457431a4845d5ff5fa205f670b7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a17b9e7a92cacdbc3b7220d968b204525"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a17b9e7a92cacdbc3b7220d968b204525">cycle</a> (void)</td></tr>
<tr class="memdesc:a17b9e7a92cacdbc3b7220d968b204525"><td class="mdescLeft">&#160;</td><td class="mdescRight">Cycle function for light sensor thread We wait in this while loop checking for requests from watchdog for health status.  <a href="#a17b9e7a92cacdbc3b7220d968b204525">More...</a><br /></td></tr>
<tr class="separator:a17b9e7a92cacdbc3b7220d968b204525"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a57d6c7de6874cb33b372559ea24ebb85"><td class="memItemLeft" align="right" valign="top">mqd_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a57d6c7de6874cb33b372559ea24ebb85">get_light_queue</a> (void)</td></tr>
<tr class="memdesc:a57d6c7de6874cb33b372559ea24ebb85"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get file descriptor for light sensor thread. Called by watchdog thread in order to be able to send heartbeat check via queue.  <a href="#a57d6c7de6874cb33b372559ea24ebb85">More...</a><br /></td></tr>
<tr class="separator:a57d6c7de6874cb33b372559ea24ebb85"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abafa0fdb40560c48e4b98ec10f0e1f43"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#abafa0fdb40560c48e4b98ec10f0e1f43">light_queue_init</a> (void)</td></tr>
<tr class="memdesc:abafa0fdb40560c48e4b98ec10f0e1f43"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize message queue for light sensor thread.  <a href="#abafa0fdb40560c48e4b98ec10f0e1f43">More...</a><br /></td></tr>
<tr class="separator:abafa0fdb40560c48e4b98ec10f0e1f43"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1a3ec39083c9a030ae43f0e8bd3ea71d"><td class="memItemLeft" align="right" valign="top">void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="light_8c.html#a1a3ec39083c9a030ae43f0e8bd3ea71d">light_fn</a> (void *thread_args)</td></tr>
<tr class="memdesc:a1a3ec39083c9a030ae43f0e8bd3ea71d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Entry point for light sensor processing thread.  <a href="#a1a3ec39083c9a030ae43f0e8bd3ea71d">More...</a><br /></td></tr>
<tr class="separator:a1a3ec39083c9a030ae43f0e8bd3ea71d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a7c22bf62313ce4f2bbe148ca7ba2abd3"><td class="memItemLeft" align="right" valign="top"><a id="a7c22bf62313ce4f2bbe148ca7ba2abd3"></a>
static timer_t&#160;</td><td class="memItemRight" valign="bottom"><b>timerid</b></td></tr>
<tr class="separator:a7c22bf62313ce4f2bbe148ca7ba2abd3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3dfce1828c167eae81a00615b18296df"><td class="memItemLeft" align="right" valign="top"><a id="a3dfce1828c167eae81a00615b18296df"></a>
struct itimerspec&#160;</td><td class="memItemRight" valign="bottom"><b>trigger</b></td></tr>
<tr class="separator:a3dfce1828c167eae81a00615b18296df"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a98be0c2951e1b0d2613e16324c8e569c"><td class="memItemLeft" align="right" valign="top"><a id="a98be0c2951e1b0d2613e16324c8e569c"></a>
static <a class="el" href="structi2c__handle__t.html">i2c_handle_t</a>&#160;</td><td class="memItemRight" valign="bottom"><b>i2c_apds9301</b></td></tr>
<tr class="separator:a98be0c2951e1b0d2613e16324c8e569c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9619c20b05cd6ad35d7ff8651cc29a7e"><td class="memItemLeft" align="right" valign="top"><a id="a9619c20b05cd6ad35d7ff8651cc29a7e"></a>
static float&#160;</td><td class="memItemRight" valign="bottom"><b>last_lux_value</b> = -5</td></tr>
<tr class="separator:a9619c20b05cd6ad35d7ff8651cc29a7e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a65781390ecf1a5a022a3dfe0bc13b8cb"><td class="memItemLeft" align="right" valign="top"><a id="a65781390ecf1a5a022a3dfe0bc13b8cb"></a>
static mqd_t&#160;</td><td class="memItemRight" valign="bottom"><b>light_queue</b></td></tr>
<tr class="separator:a65781390ecf1a5a022a3dfe0bc13b8cb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0595a9426215e130f99f34805ad48965"><td class="memItemLeft" align="right" valign="top"><a id="a0595a9426215e130f99f34805ad48965"></a>
static <a class="el" href="structshared__data__t.html">shared_data_t</a> *&#160;</td><td class="memItemRight" valign="bottom"><b>shm</b></td></tr>
<tr class="separator:a0595a9426215e130f99f34805ad48965"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Interface to APDS9301 Light Sensor. </p>
<p>=================================================================================</p>
<p>&lt;+DETAILED+&gt;</p>
<dl class="section author"><dt>Author</dt><dd>Roberto Baquerizo (baquerrj), <a href="#" onclick="location.href='mai'+'lto:'+'rob'+'a8'+'460'+'@c'+'olo'+'ra'+'do.'+'ed'+'u'; return false;">roba8<span style="display: none;">.nosp@m.</span>460@<span style="display: none;">.nosp@m.</span>color<span style="display: none;">.nosp@m.</span>ado.<span style="display: none;">.nosp@m.</span>edu</a> </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a145d5bf45a3d1527eaa860a2a4ce545b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a145d5bf45a3d1527eaa860a2a4ce545b">&#9670;&nbsp;</a></span>apds9301_clear_interrupt()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int apds9301_clear_interrupt </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Clears any pending interrupt for APDS9301 by writing a 1 to the CLEAR bit of the Command Register. </p>
<p>================================================================================= Function: apds9301_clear_interrupt </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">void</td><td><h1>see i2c_set() </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;{</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;   uint8_t clear = <a class="code" href="light_8h.html#ac2e33218e7b5df546d974d0c766d8b0b">APDS9301_REG_CMD</a> | CMD_CLEAR_INTR;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;   <span class="keywordtype">int</span> retVal = i2c_set( APDS9301_ADDRESS, clear );</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;   <span class="keywordflow">return</span> retVal;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;}</div><div class="ttc" id="light_8h_html_ac2e33218e7b5df546d974d0c766d8b0b"><div class="ttname"><a href="light_8h.html#ac2e33218e7b5df546d974d0c766d8b0b">APDS9301_REG_CMD</a></div><div class="ttdeci">#define APDS9301_REG_CMD</div><div class="ttdef"><b>Definition:</b> light.h:31</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a14680b863ba54159dba03357d4745a16"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a14680b863ba54159dba03357d4745a16">&#9670;&nbsp;</a></span>apds9301_get_lux()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int apds9301_get_lux </td>
          <td>(</td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>lux</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read ADC Registers and calculate lux in lumen using equations from APDS9301 datasheet. </p>
<p>Read ADC Registers and calculate lux in lumen.</p>
<p>================================================================================= Function: apds9301_get_lux </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">*lux</td><td>- pointer to location to write decoded lux to <h1>EXIT_CLEAN if successful, otherwise EXIT_ERROR </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;{</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;   <span class="keywordtype">float</span> ratio = 0;</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;   uint16_t data0 = 0;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;   uint16_t data1 = 0;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;   <span class="keywordtype">int</span> retVal = <a class="code" href="light_8c.html#a96f9f9c1e4e86cc148aa0a334a399d8d">apds9301_read_data0</a>( &amp;data0 );</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;   <span class="keywordflow">if</span>( EXIT_CLEAN != retVal )</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;   {</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;      <span class="keywordflow">return</span> EXIT_ERROR;</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;   }</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;   retVal = <a class="code" href="light_8c.html#a342a83b7263a75c5b12bffc638b2797e">apds9301_read_data1</a>( &amp;data1 );</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;   <span class="keywordflow">if</span>( EXIT_CLEAN != retVal )</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;   {</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;      <span class="keywordflow">return</span> EXIT_ERROR;</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;   }</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;   <span class="keywordflow">if</span>( 0 == data0 )</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;   {</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;      ratio = 0.0;</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;   }</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;   {</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;      ratio = (float)data1 / (<span class="keywordtype">float</span>)data0;</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;   }</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;   <span class="keywordflow">if</span>( (0 &lt; ratio) &amp;&amp; (0.50 &gt;= ratio) )</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;   {</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;      *lux = 0.0304*data0 - 0.062*data0*(pow(ratio, 1.4));</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    }</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (0.50 &lt; ratio) &amp;&amp; (0.61 &gt;= ratio) )</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    {</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        *lux = 0.0224*data0 - 0.031*data1;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    }</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (0.61 &lt; ratio) &amp;&amp; (0.80 &gt;= ratio) )</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    {</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        *lux = 0.0128*data0 - 0.0153*data1;</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    }</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (0.80 &lt; ratio) &amp;&amp; (1.30 &gt;= ratio) )</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    {</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;        *lux = 0.00146*data0 - 0.00112*data1;</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    }</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( 1.30 &lt; ratio )</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    {</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;        *lux = 0;</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;   }</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;   <span class="keywordflow">return</span> EXIT_CLEAN;</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;}</div><div class="ttc" id="light_8c_html_a342a83b7263a75c5b12bffc638b2797e"><div class="ttname"><a href="light_8c.html#a342a83b7263a75c5b12bffc638b2797e">apds9301_read_data1</a></div><div class="ttdeci">int apds9301_read_data1(uint16_t *data)</div><div class="ttdoc">Read ADC register for channel 1. </div><div class="ttdef"><b>Definition:</b> light.c:504</div></div>
<div class="ttc" id="light_8c_html_a96f9f9c1e4e86cc148aa0a334a399d8d"><div class="ttname"><a href="light_8c.html#a96f9f9c1e4e86cc148aa0a334a399d8d">apds9301_read_data0</a></div><div class="ttdeci">int apds9301_read_data0(uint16_t *data)</div><div class="ttdoc">Read ADC register for channel 0. </div><div class="ttdef"><b>Definition:</b> light.c:472</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a163ea457431a4845d5ff5fa205f670b7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a163ea457431a4845d5ff5fa205f670b7">&#9670;&nbsp;</a></span>apds9301_power()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int apds9301_power </td>
          <td>(</td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>on</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>power on (or off) APDS9301 as set by paramater </p>
<p>================================================================================= Function: apds9301_power </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">on</td><td>- specifies if sensor is to be powered on or off <h1>see <a class="el" href="i2c_8c.html#acf2df3bfc71068fc8d551eed2a6e7341" title="Writes byte to register address. ">i2c_write_byte()</a> </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;{</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;   <span class="keywordtype">int</span> retVal = 0;</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;   <span class="keywordflow">if</span>( on )</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;   {</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;      <span class="comment">/* power on */</span></div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;      retVal = <a class="code" href="i2c_8c.html#acf2df3bfc71068fc8d551eed2a6e7341">i2c_write_byte</a>( APDS9301_ADDRESS, APDS9301_REG_CNTRL, <a class="code" href="light_8h.html#a14cdc4396ca692461b59fb937003115b">POWER_ON</a> );</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;   }</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;   {</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;      <span class="comment">/* power off */</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;      retVal = <a class="code" href="i2c_8c.html#acf2df3bfc71068fc8d551eed2a6e7341">i2c_write_byte</a>( APDS9301_ADDRESS, APDS9301_REG_CNTRL, POWER_OFF );</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;   }</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;   <span class="keywordflow">return</span> retVal;</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;}</div><div class="ttc" id="i2c_8c_html_acf2df3bfc71068fc8d551eed2a6e7341"><div class="ttname"><a href="i2c_8c.html#acf2df3bfc71068fc8d551eed2a6e7341">i2c_write_byte</a></div><div class="ttdeci">int i2c_write_byte(int slave, int reg, uint8_t data)</div><div class="ttdoc">Writes byte to register address. </div><div class="ttdef"><b>Definition:</b> i2c.c:77</div></div>
<div class="ttc" id="light_8h_html_a14cdc4396ca692461b59fb937003115b"><div class="ttname"><a href="light_8h.html#a14cdc4396ca692461b59fb937003115b">POWER_ON</a></div><div class="ttdeci">#define POWER_ON</div><div class="ttdef"><b>Definition:</b> light.h:46</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a8e844b99f75ecdf6712faaaddc0eb396"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8e844b99f75ecdf6712faaaddc0eb396">&#9670;&nbsp;</a></span>apds9301_read_control()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int apds9301_read_control </td>
          <td>(</td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>data</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read contents of Control Register. </p>
<p>================================================================================= Function: apds9301_read_control </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">*data</td><td>- where to store contents <h1>see <a class="el" href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f" title="Reads data from register address. ">i2c_read()</a> </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;{</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;   <span class="keywordtype">int</span> retVal = <a class="code" href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a>( APDS9301_ADDRESS, APDS9301_REG_CNTRL, data, <span class="keyword">sizeof</span>( *data ) );</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;   <span class="keywordflow">return</span> retVal;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;}</div><div class="ttc" id="i2c_8c_html_aeecccc19faa9d25c282c0341631b7d2f"><div class="ttname"><a href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a></div><div class="ttdeci">int i2c_read(int slave, int reg, uint8_t *data, size_t len)</div><div class="ttdoc">Reads data from register address. </div><div class="ttdef"><b>Definition:</b> i2c.c:150</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a96f9f9c1e4e86cc148aa0a334a399d8d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a96f9f9c1e4e86cc148aa0a334a399d8d">&#9670;&nbsp;</a></span>apds9301_read_data0()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int apds9301_read_data0 </td>
          <td>(</td>
          <td class="paramtype">uint16_t *&#160;</td>
          <td class="paramname"><em>data</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read ADC register for channel 0. </p>
<p>================================================================================= function: apds9301_read_data0 </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">*data</td><td>- pointer to location to write decoded value to <h1>EXIT_CLEAN if successful, otherwise exit_error </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;{</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;   uint8_t low  = 0;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;   uint8_t high = 0;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;   <span class="keywordtype">int</span> retVal = <a class="code" href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a>( APDS9301_ADDRESS, APDS9301_REG_DLOW_0, &amp;low, 0 );</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;   <span class="keywordflow">if</span>( EXIT_CLEAN != retVal )</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;   {</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;     <span class="keywordflow">return</span> EXIT_ERROR;</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;   }</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;   retVal = <a class="code" href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a>( APDS9301_ADDRESS, APDS9301_REG_DHIGH_0, &amp;high, 0 );</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;   <span class="keywordflow">if</span>( EXIT_CLEAN == retVal )</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;   {</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;      *data = ( low | (high &lt;&lt; 8 ) );</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;   }</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;   {</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;      <span class="keywordflow">return</span> EXIT_ERROR;</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;   }</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;   <span class="keywordflow">return</span> EXIT_CLEAN;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;}</div><div class="ttc" id="i2c_8c_html_aeecccc19faa9d25c282c0341631b7d2f"><div class="ttname"><a href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a></div><div class="ttdeci">int i2c_read(int slave, int reg, uint8_t *data, size_t len)</div><div class="ttdoc">Reads data from register address. </div><div class="ttdef"><b>Definition:</b> i2c.c:150</div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="light_8c_a96f9f9c1e4e86cc148aa0a334a399d8d_icgraph.png" border="0" usemap="#light_8c_a96f9f9c1e4e86cc148aa0a334a399d8d_icgraph" alt=""/></div>
<!-- MAP 1 -->
</div>

</div>
</div>
<a id="a342a83b7263a75c5b12bffc638b2797e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a342a83b7263a75c5b12bffc638b2797e">&#9670;&nbsp;</a></span>apds9301_read_data1()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int apds9301_read_data1 </td>
          <td>(</td>
          <td class="paramtype">uint16_t *&#160;</td>
          <td class="paramname"><em>data</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read ADC register for channel 1. </p>
<p>================================================================================= function: apds9301_read_data1 </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">*data</td><td>- pointer to location to write decoded value to <h1>EXIT_CLEAN if successful, otherwise exit_error </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;{</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;   uint8_t low  = 0;</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;   uint8_t high = 0;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;   <span class="keywordtype">int</span> retVal = <a class="code" href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a>( APDS9301_ADDRESS, APDS9301_REG_DLOW_1, &amp;low, 0 );</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;   <span class="keywordflow">if</span>( EXIT_CLEAN != retVal )</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;   {</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;     <span class="keywordflow">return</span> EXIT_ERROR;</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;   }</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;   retVal = <a class="code" href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a>( APDS9301_ADDRESS, APDS9301_REG_DHIGH_1, &amp;high, 0 );</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;   <span class="keywordflow">if</span>( EXIT_CLEAN == retVal )</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;   {</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;      *data = ( low | (high &lt;&lt; 8 ) );</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;   }</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;   {</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;      <span class="keywordflow">return</span> EXIT_ERROR;</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;   }</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;   <span class="keywordflow">return</span> EXIT_CLEAN;</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;}</div><div class="ttc" id="i2c_8c_html_aeecccc19faa9d25c282c0341631b7d2f"><div class="ttname"><a href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a></div><div class="ttdeci">int i2c_read(int slave, int reg, uint8_t *data, size_t len)</div><div class="ttdoc">Reads data from register address. </div><div class="ttdef"><b>Definition:</b> i2c.c:150</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a6dbf3801330c345b999db86f018c94cf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6dbf3801330c345b999db86f018c94cf">&#9670;&nbsp;</a></span>apds9301_read_id()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int apds9301_read_id </td>
          <td>(</td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read APDS9301 Identification Register. </p>
<p>================================================================================= Function: apds9301_read_id </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">*id</td><td>- where to write ID from register <h1>see <a class="el" href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f" title="Reads data from register address. ">i2c_read()</a> </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;{</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;   <span class="keywordtype">int</span> retVal = <a class="code" href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a>( APDS9301_ADDRESS, APDS9301_REG_ID, <span class="keywordtype">id</span>, <span class="keyword">sizeof</span>( *<span class="keywordtype">id</span> ) );</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;   <span class="keywordflow">return</span> retVal;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;}</div><div class="ttc" id="i2c_8c_html_aeecccc19faa9d25c282c0341631b7d2f"><div class="ttname"><a href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a></div><div class="ttdeci">int i2c_read(int slave, int reg, uint8_t *data, size_t len)</div><div class="ttdoc">Reads data from register address. </div><div class="ttdef"><b>Definition:</b> i2c.c:150</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a0005300d36508d20c372b5355d6546d9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0005300d36508d20c372b5355d6546d9">&#9670;&nbsp;</a></span>apds9301_read_threshold_high()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int apds9301_read_threshold_high </td>
          <td>(</td>
          <td class="paramtype">uint16_t *&#160;</td>
          <td class="paramname"><em>threshold</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read value from high threshold register. </p>
<p>================================================================================= Function: apds9301_write_threshold_high </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">*threshold</td><td>- where to write value read <h1>see <a class="el" href="i2c_8c.html#a3b5f6dfe9cedb7ea92f9076cfc25c472" title="Writes data to register address. ">i2c_write()</a> </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;{</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;   <span class="keywordtype">int</span> retVal = <a class="code" href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a>( APDS9301_ADDRESS, APDS9301_REG_TH_HL, (uint8_t*)threshold, <span class="keyword">sizeof</span>( *threshold ) );</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;   <span class="keywordflow">return</span> retVal;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;}</div><div class="ttc" id="i2c_8c_html_aeecccc19faa9d25c282c0341631b7d2f"><div class="ttname"><a href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a></div><div class="ttdeci">int i2c_read(int slave, int reg, uint8_t *data, size_t len)</div><div class="ttdoc">Reads data from register address. </div><div class="ttdef"><b>Definition:</b> i2c.c:150</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a67500fb59f0ab2f2e46c3b6f945985b5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a67500fb59f0ab2f2e46c3b6f945985b5">&#9670;&nbsp;</a></span>apds9301_read_threshold_low()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int apds9301_read_threshold_low </td>
          <td>(</td>
          <td class="paramtype">uint16_t *&#160;</td>
          <td class="paramname"><em>threshold</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read value from low threshold register. </p>
<p>================================================================================= Function: apds9301_write_threshold_low </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">*threshold</td><td>- where to write value read <h1>see <a class="el" href="i2c_8c.html#a3b5f6dfe9cedb7ea92f9076cfc25c472" title="Writes data to register address. ">i2c_write()</a> </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;{</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;   <span class="keywordtype">int</span> retVal = <a class="code" href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a>( APDS9301_ADDRESS, APDS9301_REG_TH_LL, (uint8_t*)threshold, <span class="keyword">sizeof</span>( *threshold ) );</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;   <span class="keywordflow">return</span> retVal;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;}</div><div class="ttc" id="i2c_8c_html_aeecccc19faa9d25c282c0341631b7d2f"><div class="ttname"><a href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a></div><div class="ttdeci">int i2c_read(int slave, int reg, uint8_t *data, size_t len)</div><div class="ttdoc">Reads data from register address. </div><div class="ttdef"><b>Definition:</b> i2c.c:150</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ac3c04aef00858dc27815e190f8186cfd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac3c04aef00858dc27815e190f8186cfd">&#9670;&nbsp;</a></span>apds9301_set_config()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int apds9301_set_config </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set configuration of light sensor. For the APDS9301, the configuration is spread out across the: Timing Register, Interrupt Control Register, and Control Register. So, I have to write to all of these to set the config. </p>
<p>================================================================================= Function: apds9301_set_config </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">void</td><td><h1>EXIT_CLEAN if successful, otherwise see <a class="el" href="i2c_8c.html#a3b5f6dfe9cedb7ea92f9076cfc25c472" title="Writes data to register address. ">i2c_write()</a> </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;{</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;   <span class="keywordtype">int</span> retVal = <a class="code" href="light_8c.html#a3063fd5cfc043ce2ac7c67f8af9b4b2e">apds9301_set_gain</a>( <a class="code" href="light_8h.html#ae242ab0e0a91e95de561944085dbdf20">DEFAULT_GAIN</a> );</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;   <span class="keywordflow">if</span>( retVal )</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;   {</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;      <span class="keywordflow">return</span> retVal;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;   }</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;   {</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;      retVal = <a class="code" href="light_8c.html#a3b06e19e8c55d93415a41352cf11de16">apds9301_set_interrupt</a>( DEFAULT_INTERRUPT );</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;      <span class="keywordflow">if</span>( retVal )</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;      {</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;         <span class="keywordflow">return</span> retVal;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;      }</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;      {</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;         retVal = <a class="code" href="light_8c.html#a99e9814d23261d099bf5d381d84d6642">apds9301_set_integration</a>( DEFAULT_INTEGRATION_TIME );</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;         <span class="keywordflow">if</span>( retVal )</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;         {</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;            <span class="keywordflow">return</span> retVal;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;         }</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;      }</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;   }</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;   <span class="keywordflow">return</span> EXIT_CLEAN;</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;}</div><div class="ttc" id="light_8h_html_ae242ab0e0a91e95de561944085dbdf20"><div class="ttname"><a href="light_8h.html#ae242ab0e0a91e95de561944085dbdf20">DEFAULT_GAIN</a></div><div class="ttdeci">#define DEFAULT_GAIN</div><div class="ttdef"><b>Definition:</b> light.h:52</div></div>
<div class="ttc" id="light_8c_html_a3063fd5cfc043ce2ac7c67f8af9b4b2e"><div class="ttname"><a href="light_8c.html#a3063fd5cfc043ce2ac7c67f8af9b4b2e">apds9301_set_gain</a></div><div class="ttdeci">int apds9301_set_gain(uint8_t gain)</div><div class="ttdoc">Sets gain for APDS9301 by setting or clearing the GAIN bit of the Timing Register. </div><div class="ttdef"><b>Definition:</b> light.c:288</div></div>
<div class="ttc" id="light_8c_html_a99e9814d23261d099bf5d381d84d6642"><div class="ttname"><a href="light_8c.html#a99e9814d23261d099bf5d381d84d6642">apds9301_set_integration</a></div><div class="ttdeci">int apds9301_set_integration(uint8_t val)</div><div class="ttdoc">Sets the integration time for APDS9301 by writing a value to bits INTEG of the Timing Register...</div><div class="ttdef"><b>Definition:</b> light.c:201</div></div>
<div class="ttc" id="light_8c_html_a3b06e19e8c55d93415a41352cf11de16"><div class="ttname"><a href="light_8c.html#a3b06e19e8c55d93415a41352cf11de16">apds9301_set_interrupt</a></div><div class="ttdeci">int apds9301_set_interrupt(uint8_t enable)</div><div class="ttdoc">Enables or disables interrupts for APDS9301 by setting or clearing the INTR bits of the Interrupt Con...</div><div class="ttdef"><b>Definition:</b> light.c:255</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a3063fd5cfc043ce2ac7c67f8af9b4b2e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3063fd5cfc043ce2ac7c67f8af9b4b2e">&#9670;&nbsp;</a></span>apds9301_set_gain()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int apds9301_set_gain </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>gain</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sets gain for APDS9301 by setting or clearing the GAIN bit of the Timing Register. </p>
<p>================================================================================= Function: apds9301_set_gain </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">gain</td><td>- set if we want high gain <h1>see <a class="el" href="i2c_8c.html#acf2df3bfc71068fc8d551eed2a6e7341" title="Writes byte to register address. ">i2c_write_byte()</a> </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;{</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;   uint8_t data;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;   <span class="keywordtype">int</span> retVal = <a class="code" href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a>( APDS9301_ADDRESS, APDS9301_REG_TIME, &amp;data, <span class="keyword">sizeof</span>( data ) );</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;   <span class="keywordflow">if</span>( retVal )</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;   {</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;      <span class="keywordflow">return</span> EXIT_ERROR;</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;   }</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;   <span class="comment">/* if gain != 0, high gain */</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;   <span class="keywordflow">if</span>( gain )</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;   {</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;      data |= (1&lt;&lt;4);</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;   }</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;   {</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;      data &amp;= ~(1&lt;&lt;4);</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;   }</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;   retVal = <a class="code" href="i2c_8c.html#acf2df3bfc71068fc8d551eed2a6e7341">i2c_write_byte</a>( APDS9301_ADDRESS, APDS9301_REG_TIME, data );</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;   <span class="keywordflow">return</span> retVal;</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;}</div><div class="ttc" id="i2c_8c_html_aeecccc19faa9d25c282c0341631b7d2f"><div class="ttname"><a href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a></div><div class="ttdeci">int i2c_read(int slave, int reg, uint8_t *data, size_t len)</div><div class="ttdoc">Reads data from register address. </div><div class="ttdef"><b>Definition:</b> i2c.c:150</div></div>
<div class="ttc" id="i2c_8c_html_acf2df3bfc71068fc8d551eed2a6e7341"><div class="ttname"><a href="i2c_8c.html#acf2df3bfc71068fc8d551eed2a6e7341">i2c_write_byte</a></div><div class="ttdeci">int i2c_write_byte(int slave, int reg, uint8_t data)</div><div class="ttdoc">Writes byte to register address. </div><div class="ttdef"><b>Definition:</b> i2c.c:77</div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="light_8c_a3063fd5cfc043ce2ac7c67f8af9b4b2e_icgraph.png" border="0" usemap="#light_8c_a3063fd5cfc043ce2ac7c67f8af9b4b2e_icgraph" alt=""/></div>
<!-- MAP 2 -->
</div>

</div>
</div>
<a id="a99e9814d23261d099bf5d381d84d6642"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a99e9814d23261d099bf5d381d84d6642">&#9670;&nbsp;</a></span>apds9301_set_integration()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int apds9301_set_integration </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>val</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sets the integration time for APDS9301 by writing a value to bits INTEG of the Timing Register. </p>
<p>================================================================================= Function: apds9301_set_integration </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">val</td><td>- value to write to timing register <h1>see <a class="el" href="i2c_8c.html#acf2df3bfc71068fc8d551eed2a6e7341" title="Writes byte to register address. ">i2c_write_byte()</a> - if val is not an allowed value, EXIT_ERROR </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;{</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;   <span class="keywordflow">if</span>( 3 &lt; val )</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;   {</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;      <span class="comment">/* invalid value */</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;      <span class="keywordflow">return</span> EXIT_ERROR;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;   }</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;   uint8_t data;</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;   <span class="keywordtype">int</span> retVal = <a class="code" href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a>( APDS9301_ADDRESS, APDS9301_REG_TIME, &amp;data, <span class="keyword">sizeof</span>( data ) );</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;   <span class="keywordflow">if</span>( retVal )</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;   {</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;      <span class="keywordflow">return</span> EXIT_ERROR;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;   }</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;   data &amp;= ~(0b11);  <span class="comment">/* clears lower 2 bits of TIMING REG */</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;   data |= val;</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;   retVal = <a class="code" href="i2c_8c.html#acf2df3bfc71068fc8d551eed2a6e7341">i2c_write_byte</a>( APDS9301_ADDRESS, APDS9301_REG_TIME, data );</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;   <span class="keywordflow">return</span> retVal;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;}</div><div class="ttc" id="i2c_8c_html_aeecccc19faa9d25c282c0341631b7d2f"><div class="ttname"><a href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a></div><div class="ttdeci">int i2c_read(int slave, int reg, uint8_t *data, size_t len)</div><div class="ttdoc">Reads data from register address. </div><div class="ttdef"><b>Definition:</b> i2c.c:150</div></div>
<div class="ttc" id="i2c_8c_html_acf2df3bfc71068fc8d551eed2a6e7341"><div class="ttname"><a href="i2c_8c.html#acf2df3bfc71068fc8d551eed2a6e7341">i2c_write_byte</a></div><div class="ttdeci">int i2c_write_byte(int slave, int reg, uint8_t data)</div><div class="ttdoc">Writes byte to register address. </div><div class="ttdef"><b>Definition:</b> i2c.c:77</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a3b06e19e8c55d93415a41352cf11de16"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3b06e19e8c55d93415a41352cf11de16">&#9670;&nbsp;</a></span>apds9301_set_interrupt()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int apds9301_set_interrupt </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>enable</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Enables or disables interrupts for APDS9301 by setting or clearing the INTR bits of the Interrupt Control Register. </p>
<p>================================================================================= Function: apds9301_set_interrupt </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">enable</td><td>- set if we want to enable interrupts <h1>see <a class="el" href="i2c_8c.html#acf2df3bfc71068fc8d551eed2a6e7341" title="Writes byte to register address. ">i2c_write_byte()</a> </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;{</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;   uint8_t data;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;   <span class="keywordtype">int</span> retVal = <a class="code" href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a>( APDS9301_ADDRESS, APDS9301_REG_INT_CNTRL, &amp;data, <span class="keyword">sizeof</span>( data ) );</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;   <span class="keywordflow">if</span>( retVal )</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;   {</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;      <span class="keywordflow">return</span> EXIT_ERROR;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;   }</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;   <span class="keywordflow">if</span>( enable )</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;   {</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;      data |= (1&lt;&lt;4);</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;   }</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;   {</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;      data &amp;= ~(1&lt;&lt;4);</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;   }</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;   retVal = <a class="code" href="i2c_8c.html#acf2df3bfc71068fc8d551eed2a6e7341">i2c_write_byte</a>( APDS9301_ADDRESS, APDS9301_REG_INT_CNTRL, data );</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;   <span class="keywordflow">return</span> retVal;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;}</div><div class="ttc" id="i2c_8c_html_aeecccc19faa9d25c282c0341631b7d2f"><div class="ttname"><a href="i2c_8c.html#aeecccc19faa9d25c282c0341631b7d2f">i2c_read</a></div><div class="ttdeci">int i2c_read(int slave, int reg, uint8_t *data, size_t len)</div><div class="ttdoc">Reads data from register address. </div><div class="ttdef"><b>Definition:</b> i2c.c:150</div></div>
<div class="ttc" id="i2c_8c_html_acf2df3bfc71068fc8d551eed2a6e7341"><div class="ttname"><a href="i2c_8c.html#acf2df3bfc71068fc8d551eed2a6e7341">i2c_write_byte</a></div><div class="ttdeci">int i2c_write_byte(int slave, int reg, uint8_t data)</div><div class="ttdoc">Writes byte to register address. </div><div class="ttdef"><b>Definition:</b> i2c.c:77</div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="light_8c_a3b06e19e8c55d93415a41352cf11de16_icgraph.png" border="0" usemap="#light_8c_a3b06e19e8c55d93415a41352cf11de16_icgraph" alt=""/></div>
<!-- MAP 3 -->
</div>

</div>
</div>
<a id="adb39e9954b4d948edea845453df2abf6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adb39e9954b4d948edea845453df2abf6">&#9670;&nbsp;</a></span>apds9301_write_threshold_high()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int apds9301_write_threshold_high </td>
          <td>(</td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>threshold</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Write value to high threshold register. </p>
<p>================================================================================= Function: apds9301_write_threshold_high </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">threshold</td><td>- value to write <h1>see <a class="el" href="i2c_8c.html#a3b5f6dfe9cedb7ea92f9076cfc25c472" title="Writes data to register address. ">i2c_write()</a> </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;{</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;   <span class="keywordtype">int</span> retVal = <a class="code" href="i2c_8c.html#a3b5f6dfe9cedb7ea92f9076cfc25c472">i2c_write</a>( APDS9301_ADDRESS, APDS9301_REG_TH_HL, threshold );</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;   <span class="keywordflow">return</span> retVal;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;}</div><div class="ttc" id="i2c_8c_html_a3b5f6dfe9cedb7ea92f9076cfc25c472"><div class="ttname"><a href="i2c_8c.html#a3b5f6dfe9cedb7ea92f9076cfc25c472">i2c_write</a></div><div class="ttdeci">int i2c_write(int slave, int reg, uint16_t data)</div><div class="ttdoc">Writes data to register address. </div><div class="ttdef"><b>Definition:</b> i2c.c:113</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ae2c85da2e138447c5881122669c36a38"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae2c85da2e138447c5881122669c36a38">&#9670;&nbsp;</a></span>apds9301_write_threshold_low()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int apds9301_write_threshold_low </td>
          <td>(</td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>threshold</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Write value to low threshold register. </p>
<p>================================================================================= Function: apds9301_write_threshold_low </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">threshold</td><td>- value to write <h1>see <a class="el" href="i2c_8c.html#a3b5f6dfe9cedb7ea92f9076cfc25c472" title="Writes data to register address. ">i2c_write()</a> </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;{</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;   <span class="keywordtype">int</span> retVal = <a class="code" href="i2c_8c.html#a3b5f6dfe9cedb7ea92f9076cfc25c472">i2c_write</a>( APDS9301_ADDRESS, APDS9301_REG_TH_LL, threshold );</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;   <span class="keywordflow">return</span> retVal;</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;}</div><div class="ttc" id="i2c_8c_html_a3b5f6dfe9cedb7ea92f9076cfc25c472"><div class="ttname"><a href="i2c_8c.html#a3b5f6dfe9cedb7ea92f9076cfc25c472">i2c_write</a></div><div class="ttdeci">int i2c_write(int slave, int reg, uint16_t data)</div><div class="ttdoc">Writes data to register address. </div><div class="ttdef"><b>Definition:</b> i2c.c:113</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a17b9e7a92cacdbc3b7220d968b204525"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a17b9e7a92cacdbc3b7220d968b204525">&#9670;&nbsp;</a></span>cycle()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void cycle </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Cycle function for light sensor thread We wait in this while loop checking for requests from watchdog for health status. </p>
<p>================================================================================= Function: cycle </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">void</td><td><h1>void </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;{</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;   <span class="keywordtype">int</span> retVal = 0;</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;   <a class="code" href="structmsg__t.html">msg_t</a> request = {0};</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;   <a class="code" href="structmsg__t.html">msg_t</a> response = {0};</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;   <span class="keywordflow">while</span>( 1 )</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;   {</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;      memset( &amp;request, 0, <span class="keyword">sizeof</span>( request ) );</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;      retVal = mq_receive( light_queue, (<span class="keywordtype">char</span>*)&amp;request, <span class="keyword">sizeof</span>( request ), NULL );</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;      <span class="keywordflow">if</span>( 0 &gt; retVal )</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;      {</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;         <span class="keywordtype">int</span> errnum = errno;</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;         fprintf( stderr, <span class="stringliteral">&quot;Encountered error receiving from message queue %s: (%s)\n&quot;</span>,</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                  LIGHT_QUEUE_NAME, strerror( errnum ) );</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;         <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;      }</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;      <span class="keywordflow">switch</span>( request.id )</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;      {</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;         <span class="keywordflow">case</span> REQUEST_STATUS:</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;            sem_wait(&amp;shm-&gt;<a class="code" href="structshared__data__t.html#aaa7bbb7121ee6cebe671dd6e2efb7763">w_sem</a>);</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;            <a class="code" href="common_8c.html#a8f714d490a7f06c3a43cfea239e2770f">print_header</a>(shm-&gt;<a class="code" href="structshared__data__t.html#aac4f21bda7f4fc47557faac246f0b3ea">header</a>);</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;            sprintf( shm-&gt;buffer, <span class="stringliteral">&quot;(Light) I am alive!\n&quot;</span> );</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;            sem_post(&amp;shm-&gt;r_sem);</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;            fprintf( stdout, <span class="stringliteral">&quot;(Light) I am alive!\n&quot;</span> );</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;            response.id = request.id;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;            sprintf( response.info, <span class="stringliteral">&quot;(Light) I am alive!\n&quot;</span> );</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;            retVal = mq_send( request.src, (<span class="keyword">const</span> <span class="keywordtype">char</span>*)&amp;response, <span class="keyword">sizeof</span>( response ), 0 );</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;            pthread_mutex_lock( &amp;alive_mutex );</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;            threads_status[THREAD_LIGHT]--;</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;            pthread_mutex_unlock( &amp;alive_mutex );</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;         <span class="keywordflow">default</span>:</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;      }</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;   }</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;   <span class="keywordflow">return</span>;</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;}</div><div class="ttc" id="structmsg__t_html"><div class="ttname"><a href="structmsg__t.html">msg_t</a></div><div class="ttdef"><b>Definition:</b> common.h:68</div></div>
<div class="ttc" id="structshared__data__t_html_aaa7bbb7121ee6cebe671dd6e2efb7763"><div class="ttname"><a href="structshared__data__t.html#aaa7bbb7121ee6cebe671dd6e2efb7763">shared_data_t::w_sem</a></div><div class="ttdeci">sem_t w_sem</div><div class="ttdef"><b>Definition:</b> common.h:102</div></div>
<div class="ttc" id="structshared__data__t_html_aac4f21bda7f4fc47557faac246f0b3ea"><div class="ttname"><a href="structshared__data__t.html#aac4f21bda7f4fc47557faac246f0b3ea">shared_data_t::header</a></div><div class="ttdeci">char header[SHM_BUFFER_SIZE]</div><div class="ttdef"><b>Definition:</b> common.h:101</div></div>
<div class="ttc" id="common_8c_html_a8f714d490a7f06c3a43cfea239e2770f"><div class="ttname"><a href="common_8c.html#a8f714d490a7f06c3a43cfea239e2770f">print_header</a></div><div class="ttdeci">void print_header(char *buffer)</div><div class="ttdoc">Write a string formatted with the TID of the thread calling this function and a timestamp to the log ...</div><div class="ttdef"><b>Definition:</b> common.c:35</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a57d6c7de6874cb33b372559ea24ebb85"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a57d6c7de6874cb33b372559ea24ebb85">&#9670;&nbsp;</a></span>get_light_queue()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">mqd_t get_light_queue </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get file descriptor for light sensor thread. Called by watchdog thread in order to be able to send heartbeat check via queue. </p>
<p>================================================================================= Function: get_light_queue </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">void</td><td><h1>temp_queue - file descriptor for light sensor thread message queue </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;{</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;   <span class="keywordflow">return</span> light_queue;</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;}</div></div><!-- fragment -->
</div>
</div>
<a id="a7f1c59e171c9db2a7609a4cd8b61fa2c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7f1c59e171c9db2a7609a4cd8b61fa2c">&#9670;&nbsp;</a></span>get_lux()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float get_lux </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Returns last lux reading. </p>
<p>================================================================================= Function: get_lux </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">void</td><td><h1>last_lux_value - last lux reading we have </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;{</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;   <span class="keywordflow">return</span> last_lux_value;</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;}</div></div><!-- fragment -->
</div>
</div>
<a id="a5ba3d2c92432bf82f3f3cc4e809b1dba"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5ba3d2c92432bf82f3f3cc4e809b1dba">&#9670;&nbsp;</a></span>is_dark()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int is_dark </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Returns int speciyfing if it is night or day. </p>
<p>================================================================================= Function: is_dark </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">void</td><td><h1>night - 0 if it is day, 1 if night, i.e. below DARK_THRESHOLD </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;{</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;   <span class="keywordtype">int</span> dark = 0;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;   <span class="keywordflow">if</span>( DARK_THRESHOLD &gt; last_lux_value )</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;   {</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;      dark = 1;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;   }</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;   <span class="keywordflow">return</span> dark;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;}</div></div><!-- fragment -->
</div>
</div>
<a id="a1a3ec39083c9a030ae43f0e8bd3ea71d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1a3ec39083c9a030ae43f0e8bd3ea71d">&#9670;&nbsp;</a></span>light_fn()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void* light_fn </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>thread_args</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Entry point for light sensor processing thread. </p>
<p>================================================================================= Function: light_fn </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">thread_args</td><td>- void ptr to arguments used to initialize thread </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>NULL - We don't really exit from this function, <h1>since the exit point is <a class="el" href="common_8c.html#a760f8eb17501e01a6673e2ec911ba1cb" title="Common exit point for all threads. ">thread_exit()</a> </h1>
</dd></dl>
<div class="fragment"><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;{</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;   <span class="comment">/* Get time that thread was spawned */</span></div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;   <span class="keyword">struct </span>timespec time;</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;   clock_gettime(CLOCK_REALTIME, &amp;time);</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;   shm = <a class="code" href="common_8c.html#ae426f169cff2eb748a7d509bda02c686">get_shared_memory</a>();</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;   <span class="comment">/* Write initial state to shared memory */</span></div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;   sem_wait(&amp;shm-&gt;<a class="code" href="structshared__data__t.html#aaa7bbb7121ee6cebe671dd6e2efb7763">w_sem</a>);</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;   <a class="code" href="common_8c.html#a8f714d490a7f06c3a43cfea239e2770f">print_header</a>(shm-&gt;<a class="code" href="structshared__data__t.html#aac4f21bda7f4fc47557faac246f0b3ea">header</a>);</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;   sprintf( shm-&gt;buffer, <span class="stringliteral">&quot;Hello World! Start Time: %ld.%ld secs\n&quot;</span>,</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;            time.tv_sec, time.tv_nsec );</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;   <span class="comment">/* Signal to logger that shared memory has been updated */</span></div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;   sem_post(&amp;shm-&gt;r_sem);</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;   signal(SIGUSR1, <a class="code" href="light_8c.html#a366471b5822de7615f33cbe5eab9726a">sig_handler</a>);</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;   signal(SIGUSR2, <a class="code" href="light_8c.html#a366471b5822de7615f33cbe5eab9726a">sig_handler</a>);</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;   light_queue = <a class="code" href="light_8c.html#abafa0fdb40560c48e4b98ec10f0e1f43">light_queue_init</a>();</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;   <span class="keywordflow">if</span>( 0 &gt; light_queue )</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;   {</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;      <a class="code" href="common_8c.html#a760f8eb17501e01a6673e2ec911ba1cb">thread_exit</a>( EXIT_INIT );</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;   }</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;   <span class="keywordtype">int</span> retVal = <a class="code" href="i2c_8c.html#a1554411301103619aa6f40b7613b5e6b">i2c_init</a>( &amp;i2c_apds9301 );</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;   <span class="keywordflow">if</span>( EXIT_INIT == retVal )</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;   {</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;      sem_wait(&amp;shm-&gt;<a class="code" href="structshared__data__t.html#aaa7bbb7121ee6cebe671dd6e2efb7763">w_sem</a>);</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;      <a class="code" href="common_8c.html#a8f714d490a7f06c3a43cfea239e2770f">print_header</a>(shm-&gt;<a class="code" href="structshared__data__t.html#aac4f21bda7f4fc47557faac246f0b3ea">header</a>);</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;      sprintf( shm-&gt;buffer, <span class="stringliteral">&quot;ERROR: Failed to initialize I2C for light sensor!\n&quot;</span> );</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;      sem_post(&amp;shm-&gt;r_sem);</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;      <a class="code" href="common_8c.html#a760f8eb17501e01a6673e2ec911ba1cb">thread_exit</a>( EXIT_INIT );</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;   }</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;   retVal = <a class="code" href="light_8c.html#a163ea457431a4845d5ff5fa205f670b7">apds9301_power</a>( <a class="code" href="light_8h.html#a14cdc4396ca692461b59fb937003115b">POWER_ON</a> );</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;   <span class="keywordflow">if</span>( retVal )</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;   {</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;      sem_wait(&amp;shm-&gt;<a class="code" href="structshared__data__t.html#aaa7bbb7121ee6cebe671dd6e2efb7763">w_sem</a>);</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;      <a class="code" href="common_8c.html#a8f714d490a7f06c3a43cfea239e2770f">print_header</a>(shm-&gt;<a class="code" href="structshared__data__t.html#aac4f21bda7f4fc47557faac246f0b3ea">header</a>);</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;      sprintf( shm-&gt;buffer, <span class="stringliteral">&quot;ERROR: Failed to power on light sensor!\n&quot;</span> );</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;      sem_post(&amp;shm-&gt;r_sem);</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;      <a class="code" href="common_8c.html#a760f8eb17501e01a6673e2ec911ba1cb">thread_exit</a>( EXIT_INIT );</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;   }</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;   <a class="code" href="common_8c.html#a78dd395e9020e2a6066233a529bff7be">timer_setup</a>( &amp;timerid, &amp;<a class="code" href="light_8c.html#a4f3aa3fb3750262d938e191252db81fb">timer_handler</a> );</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;   <a class="code" href="common_8c.html#a207644f53334379d5fcb82b78bafff36">timer_start</a>( &amp;timerid, 5000000 );</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;   <a class="code" href="light_8c.html#a17b9e7a92cacdbc3b7220d968b204525">cycle</a>();</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;   <a class="code" href="common_8c.html#a760f8eb17501e01a6673e2ec911ba1cb">thread_exit</a>( 0 );</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;   <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;}</div><div class="ttc" id="common_8c_html_a78dd395e9020e2a6066233a529bff7be"><div class="ttname"><a href="common_8c.html#a78dd395e9020e2a6066233a529bff7be">timer_setup</a></div><div class="ttdeci">int timer_setup(timer_t *id, void(*handler)(union sigval))</div><div class="ttdoc">Initializes a timer identified by timer_t id. </div><div class="ttdef"><b>Definition:</b> common.c:155</div></div>
<div class="ttc" id="light_8c_html_a4f3aa3fb3750262d938e191252db81fb"><div class="ttname"><a href="light_8c.html#a4f3aa3fb3750262d938e191252db81fb">timer_handler</a></div><div class="ttdeci">static void timer_handler(union sigval sig)</div><div class="ttdoc">Timer handler function for light sensor thread When woken up by the timer, get lux reading and write ...</div><div class="ttdef"><b>Definition:</b> light.c:83</div></div>
<div class="ttc" id="common_8c_html_ae426f169cff2eb748a7d509bda02c686"><div class="ttname"><a href="common_8c.html#ae426f169cff2eb748a7d509bda02c686">get_shared_memory</a></div><div class="ttdeci">void * get_shared_memory(void)</div><div class="ttdoc">Sets up shared memory location for logging. </div><div class="ttdef"><b>Definition:</b> common.c:82</div></div>
<div class="ttc" id="light_8c_html_a366471b5822de7615f33cbe5eab9726a"><div class="ttname"><a href="light_8c.html#a366471b5822de7615f33cbe5eab9726a">sig_handler</a></div><div class="ttdeci">static void sig_handler(int signo)</div><div class="ttdoc">Signal handler for light sensor thread. On normal operation, we should be receving SIGUSR1/2 signals ...</div><div class="ttdef"><b>Definition:</b> light.c:50</div></div>
<div class="ttc" id="common_8c_html_a760f8eb17501e01a6673e2ec911ba1cb"><div class="ttname"><a href="common_8c.html#a760f8eb17501e01a6673e2ec911ba1cb">thread_exit</a></div><div class="ttdeci">void thread_exit(int exit_status)</div><div class="ttdoc">Common exit point for all threads. </div><div class="ttdef"><b>Definition:</b> common.c:60</div></div>
<div class="ttc" id="light_8c_html_a163ea457431a4845d5ff5fa205f670b7"><div class="ttname"><a href="light_8c.html#a163ea457431a4845d5ff5fa205f670b7">apds9301_power</a></div><div class="ttdeci">int apds9301_power(uint16_t on)</div><div class="ttdoc">power on (or off) APDS9301 as set by paramater </div><div class="ttdef"><b>Definition:</b> light.c:537</div></div>
<div class="ttc" id="i2c_8c_html_a1554411301103619aa6f40b7613b5e6b"><div class="ttname"><a href="i2c_8c.html#a1554411301103619aa6f40b7613b5e6b">i2c_init</a></div><div class="ttdeci">int i2c_init(i2c_handle_t *i2c)</div><div class="ttdoc">Initialize singleton master i2c context. </div><div class="ttdef"><b>Definition:</b> i2c.c:202</div></div>
<div class="ttc" id="structshared__data__t_html_aaa7bbb7121ee6cebe671dd6e2efb7763"><div class="ttname"><a href="structshared__data__t.html#aaa7bbb7121ee6cebe671dd6e2efb7763">shared_data_t::w_sem</a></div><div class="ttdeci">sem_t w_sem</div><div class="ttdef"><b>Definition:</b> common.h:102</div></div>
<div class="ttc" id="structshared__data__t_html_aac4f21bda7f4fc47557faac246f0b3ea"><div class="ttname"><a href="structshared__data__t.html#aac4f21bda7f4fc47557faac246f0b3ea">shared_data_t::header</a></div><div class="ttdeci">char header[SHM_BUFFER_SIZE]</div><div class="ttdef"><b>Definition:</b> common.h:101</div></div>
<div class="ttc" id="common_8c_html_a207644f53334379d5fcb82b78bafff36"><div class="ttname"><a href="common_8c.html#a207644f53334379d5fcb82b78bafff36">timer_start</a></div><div class="ttdeci">int timer_start(timer_t *id, unsigned long usecs)</div><div class="ttdoc">Starts the timer with interval usecs. </div><div class="ttdef"><b>Definition:</b> common.c:180</div></div>
<div class="ttc" id="light_8c_html_a17b9e7a92cacdbc3b7220d968b204525"><div class="ttname"><a href="light_8c.html#a17b9e7a92cacdbc3b7220d968b204525">cycle</a></div><div class="ttdeci">static void cycle(void)</div><div class="ttdoc">Cycle function for light sensor thread We wait in this while loop checking for requests from watchdog...</div><div class="ttdef"><b>Definition:</b> light.c:565</div></div>
<div class="ttc" id="common_8c_html_a8f714d490a7f06c3a43cfea239e2770f"><div class="ttname"><a href="common_8c.html#a8f714d490a7f06c3a43cfea239e2770f">print_header</a></div><div class="ttdeci">void print_header(char *buffer)</div><div class="ttdoc">Write a string formatted with the TID of the thread calling this function and a timestamp to the log ...</div><div class="ttdef"><b>Definition:</b> common.c:35</div></div>
<div class="ttc" id="light_8c_html_abafa0fdb40560c48e4b98ec10f0e1f43"><div class="ttname"><a href="light_8c.html#abafa0fdb40560c48e4b98ec10f0e1f43">light_queue_init</a></div><div class="ttdeci">int light_queue_init(void)</div><div class="ttdoc">Initialize message queue for light sensor thread. </div><div class="ttdef"><b>Definition:</b> light.c:628</div></div>
<div class="ttc" id="light_8h_html_a14cdc4396ca692461b59fb937003115b"><div class="ttname"><a href="light_8h.html#a14cdc4396ca692461b59fb937003115b">POWER_ON</a></div><div class="ttdeci">#define POWER_ON</div><div class="ttdef"><b>Definition:</b> light.h:46</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="abafa0fdb40560c48e4b98ec10f0e1f43"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abafa0fdb40560c48e4b98ec10f0e1f43">&#9670;&nbsp;</a></span>light_queue_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int light_queue_init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize message queue for light sensor thread. </p>
<p>================================================================================= Function: light_queue_init </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">void</td><td><h1>msg_q - file descriptor for initialized message queue </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;{</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;   <span class="comment">/* unlink first in case we hadn&#39;t shut down cleanly last time */</span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;   mq_unlink( LIGHT_QUEUE_NAME );</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;   <span class="keyword">struct </span>mq_attr attr;</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;   attr.mq_flags = 0;</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;   attr.mq_maxmsg = MAX_MESSAGES;</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;   attr.mq_msgsize = <span class="keyword">sizeof</span>( <a class="code" href="structmsg__t.html">msg_t</a> );</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;   attr.mq_curmsgs = 0;</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;   <span class="keywordtype">int</span> msg_q = mq_open( LIGHT_QUEUE_NAME, O_CREAT | O_RDWR, 0666, &amp;attr );</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;   <span class="keywordflow">if</span>( 0 &gt; msg_q )</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;   {</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;      <span class="keywordtype">int</span> errnum = errno;</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;      sem_wait(&amp;shm-&gt;<a class="code" href="structshared__data__t.html#aaa7bbb7121ee6cebe671dd6e2efb7763">w_sem</a>);</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;      <a class="code" href="common_8c.html#a8f714d490a7f06c3a43cfea239e2770f">print_header</a>(shm-&gt;<a class="code" href="structshared__data__t.html#aac4f21bda7f4fc47557faac246f0b3ea">header</a>);</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;      sprintf( shm-&gt;buffer, <span class="stringliteral">&quot;Encountered error creating message queue %s: (%s)\n&quot;</span>,</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;               LIGHT_QUEUE_NAME, strerror( errnum ) );</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;      sem_post(&amp;shm-&gt;r_sem);</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;   }</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;   <span class="keywordflow">return</span> msg_q;</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;}</div><div class="ttc" id="structmsg__t_html"><div class="ttname"><a href="structmsg__t.html">msg_t</a></div><div class="ttdef"><b>Definition:</b> common.h:68</div></div>
<div class="ttc" id="structshared__data__t_html_aaa7bbb7121ee6cebe671dd6e2efb7763"><div class="ttname"><a href="structshared__data__t.html#aaa7bbb7121ee6cebe671dd6e2efb7763">shared_data_t::w_sem</a></div><div class="ttdeci">sem_t w_sem</div><div class="ttdef"><b>Definition:</b> common.h:102</div></div>
<div class="ttc" id="structshared__data__t_html_aac4f21bda7f4fc47557faac246f0b3ea"><div class="ttname"><a href="structshared__data__t.html#aac4f21bda7f4fc47557faac246f0b3ea">shared_data_t::header</a></div><div class="ttdeci">char header[SHM_BUFFER_SIZE]</div><div class="ttdef"><b>Definition:</b> common.h:101</div></div>
<div class="ttc" id="common_8c_html_a8f714d490a7f06c3a43cfea239e2770f"><div class="ttname"><a href="common_8c.html#a8f714d490a7f06c3a43cfea239e2770f">print_header</a></div><div class="ttdeci">void print_header(char *buffer)</div><div class="ttdoc">Write a string formatted with the TID of the thread calling this function and a timestamp to the log ...</div><div class="ttdef"><b>Definition:</b> common.c:35</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a366471b5822de7615f33cbe5eab9726a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a366471b5822de7615f33cbe5eab9726a">&#9670;&nbsp;</a></span>sig_handler()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void sig_handler </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>signo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Signal handler for light sensor thread. On normal operation, we should be receving SIGUSR1/2 signals from watchdog when prompted to exit. So, we close the message queue and timer this thread owns. </p>
<p>================================================================================= Function: sig_handler </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">signo</td><td>- enum with signal number of signal being handled <h1>void </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;{</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;   <span class="keywordflow">if</span>( signo == SIGUSR1 )</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;   {</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;      printf(<span class="stringliteral">&quot;Received SIGUSR1! Exiting...\n&quot;</span>);</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;      mq_close( light_queue );</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;      timer_delete( timerid );</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;      <a class="code" href="light_8c.html#a163ea457431a4845d5ff5fa205f670b7">apds9301_power</a>( POWER_OFF );</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;      <a class="code" href="i2c_8c.html#a8f550e69702cca5887035007afe36d40">i2c_stop</a>( &amp;i2c_apds9301 );</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;      <a class="code" href="common_8c.html#a760f8eb17501e01a6673e2ec911ba1cb">thread_exit</a>( signo );</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;   }</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( signo == SIGUSR2 )</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;   {</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;      printf(<span class="stringliteral">&quot;Received SIGUSR2! Exiting...\n&quot;</span>);</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;      mq_close( light_queue );</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;      timer_delete( timerid );</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;      <a class="code" href="light_8c.html#a163ea457431a4845d5ff5fa205f670b7">apds9301_power</a>( POWER_OFF );</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;      <a class="code" href="i2c_8c.html#a8f550e69702cca5887035007afe36d40">i2c_stop</a>( &amp;i2c_apds9301 );</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;      <a class="code" href="common_8c.html#a760f8eb17501e01a6673e2ec911ba1cb">thread_exit</a>( signo );</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;   }</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;   <span class="keywordflow">return</span>;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;}</div><div class="ttc" id="i2c_8c_html_a8f550e69702cca5887035007afe36d40"><div class="ttname"><a href="i2c_8c.html#a8f550e69702cca5887035007afe36d40">i2c_stop</a></div><div class="ttdeci">int i2c_stop(i2c_handle_t *i2c)</div><div class="ttdoc">Stops i2c instance. </div><div class="ttdef"><b>Definition:</b> i2c.c:252</div></div>
<div class="ttc" id="common_8c_html_a760f8eb17501e01a6673e2ec911ba1cb"><div class="ttname"><a href="common_8c.html#a760f8eb17501e01a6673e2ec911ba1cb">thread_exit</a></div><div class="ttdeci">void thread_exit(int exit_status)</div><div class="ttdoc">Common exit point for all threads. </div><div class="ttdef"><b>Definition:</b> common.c:60</div></div>
<div class="ttc" id="light_8c_html_a163ea457431a4845d5ff5fa205f670b7"><div class="ttname"><a href="light_8c.html#a163ea457431a4845d5ff5fa205f670b7">apds9301_power</a></div><div class="ttdeci">int apds9301_power(uint16_t on)</div><div class="ttdoc">power on (or off) APDS9301 as set by paramater </div><div class="ttdef"><b>Definition:</b> light.c:537</div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="light_8c_a366471b5822de7615f33cbe5eab9726a_icgraph.png" border="0" usemap="#light_8c_a366471b5822de7615f33cbe5eab9726a_icgraph" alt=""/></div>
<!-- MAP 4 -->
</div>

</div>
</div>
<a id="a4f3aa3fb3750262d938e191252db81fb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4f3aa3fb3750262d938e191252db81fb">&#9670;&nbsp;</a></span>timer_handler()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void timer_handler </td>
          <td>(</td>
          <td class="paramtype">union sigval&#160;</td>
          <td class="paramname"><em>sig</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Timer handler function for light sensor thread When woken up by the timer, get lux reading and write state to shared memory. </p>
<p>================================================================================= Function: timer_handler </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">sig</td><td><h1>void </h1>
</td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;{</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;   <span class="keyword">static</span> <span class="keywordtype">int</span> i = 0;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;   <a class="code" href="led_8c.html#ad5a256395c8cd67d2a9f9ff1abfd6d2a">led_toggle</a>( LED1_BRIGHTNESS );</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;   sem_wait(&amp;shm-&gt;<a class="code" href="structshared__data__t.html#aaa7bbb7121ee6cebe671dd6e2efb7763">w_sem</a>);</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;   <a class="code" href="common_8c.html#a8f714d490a7f06c3a43cfea239e2770f">print_header</a>(shm-&gt;<a class="code" href="structshared__data__t.html#aac4f21bda7f4fc47557faac246f0b3ea">header</a>);</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;   <span class="keywordtype">float</span> lux = -5;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;   <span class="keywordtype">int</span> retVal = <a class="code" href="light_8c.html#a14680b863ba54159dba03357d4745a16">apds9301_get_lux</a>( &amp;lux );</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;   i++;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;   <span class="keywordflow">if</span>( retVal )</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;   {</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;      <span class="comment">/* save new lux value */</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;      last_lux_value = lux;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;      <span class="keywordflow">if</span>( DARK_THRESHOLD &gt; lux )</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;      {</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;         sprintf( shm-&gt;buffer, <span class="stringliteral">&quot;cycle[%d]: State: %s, Lux: %0.5f\n&quot;</span>,</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;                  i, <span class="stringliteral">&quot;NIGHT&quot;</span>, lux );</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;      }</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;      {</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;         sprintf( shm-&gt;buffer, <span class="stringliteral">&quot;cycle[%d]: State: %s, Lux: %0.5f\n&quot;</span>,</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                  i, <span class="stringliteral">&quot;DAY&quot;</span>, lux );</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;      }</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;   }</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;   <span class="keywordflow">else</span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;   {</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;      sprintf( shm-&gt;buffer, <span class="stringliteral">&quot;cycle[%d]: could not get light reading!\n&quot;</span>, i );</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;   }</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;   sem_post(&amp;shm-&gt;r_sem);</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;   <a class="code" href="led_8c.html#ad5a256395c8cd67d2a9f9ff1abfd6d2a">led_toggle</a>( LED1_BRIGHTNESS );</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;   <span class="keywordflow">return</span>;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;}</div><div class="ttc" id="light_8c_html_a14680b863ba54159dba03357d4745a16"><div class="ttname"><a href="light_8c.html#a14680b863ba54159dba03357d4745a16">apds9301_get_lux</a></div><div class="ttdeci">int apds9301_get_lux(float *lux)</div><div class="ttdoc">Read ADC Registers and calculate lux in lumen using equations from APDS9301 datasheet. </div><div class="ttdef"><b>Definition:</b> light.c:412</div></div>
<div class="ttc" id="structshared__data__t_html_aaa7bbb7121ee6cebe671dd6e2efb7763"><div class="ttname"><a href="structshared__data__t.html#aaa7bbb7121ee6cebe671dd6e2efb7763">shared_data_t::w_sem</a></div><div class="ttdeci">sem_t w_sem</div><div class="ttdef"><b>Definition:</b> common.h:102</div></div>
<div class="ttc" id="structshared__data__t_html_aac4f21bda7f4fc47557faac246f0b3ea"><div class="ttname"><a href="structshared__data__t.html#aac4f21bda7f4fc47557faac246f0b3ea">shared_data_t::header</a></div><div class="ttdeci">char header[SHM_BUFFER_SIZE]</div><div class="ttdef"><b>Definition:</b> common.h:101</div></div>
<div class="ttc" id="led_8c_html_ad5a256395c8cd67d2a9f9ff1abfd6d2a"><div class="ttname"><a href="led_8c.html#ad5a256395c8cd67d2a9f9ff1abfd6d2a">led_toggle</a></div><div class="ttdeci">void led_toggle(const char *led)</div><div class="ttdef"><b>Definition:</b> led.c:144</div></div>
<div class="ttc" id="common_8c_html_a8f714d490a7f06c3a43cfea239e2770f"><div class="ttname"><a href="common_8c.html#a8f714d490a7f06c3a43cfea239e2770f">print_header</a></div><div class="ttdeci">void print_header(char *buffer)</div><div class="ttdoc">Write a string formatted with the TID of the thread calling this function and a timestamp to the log ...</div><div class="ttdef"><b>Definition:</b> common.c:35</div></div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Apr 3 2019 20:47:08 for ECEN5013 Project1 - Roberto Baquerizo by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
